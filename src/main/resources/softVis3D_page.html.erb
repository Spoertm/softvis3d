<!--

    SoftVis3D Sonar plugin
    Copyright (C) 2014 Stefan Rinderle
    stefan@rinderle.info

    SoftVis3D Sonar plugin can not be copied and/or distributed without the express
    permission of Stefan Rinderle.

-->
<script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/threeJS/three.min.js"></script>

<script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/threeJS/OrbitControls.js"></script>

<script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/threeJS/Detector.js"></script>
<script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/threeJS/stats.min.js"></script>

<script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/angular/angular.min.js"></script>

<!--
<script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/angular/ui-bootstrap-tpls-0.12.0.min.js"></script>

<link rel="stylesheet" type="text/css" href="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/css/bootstrap.min.css">
-->
<link rel="stylesheet" type="text/css" href="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/css/main.css">

<%
   # get extension class and start layout
   softVis3D = Api::Utils.java_facade.
           getComponentByClassname('softVis3D', 'de.rinderle.softvis3d.SoftVis3DExtension')
%>

<% if (softVis3D.isProd()) %>
    <script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/js/softvis3d.min.js"></script>
<% else %>
    <script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/js/SoftVis3dAngular.js"></script>
    <script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/js/BackendService.js"></script>
    <script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/js/CreateObjectsService.js"></script>
    <script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/js/DetailsController.js"></script>
    <script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/js/Directives.js"></script>
    <script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/js/RenderController.js"></script>
    <script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/js/SceneObjectsService.js"></script>
    <script type="text/javascript" src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/js/TreeService.js"></script>
<% end %>

<div ng-app="softVis3dAngular" resize>

    <div id="metricForm" style="height: 30px;">
        <%
           metricIds = softVis3D.getMetricsForSnapshot(@snapshot.id)

           # get all defined metric for project files
           metrics=[]
           metricIds.each do |index|
             m = metric(index)
             metrics << m if m
           end

           # set default metric ids if no metrics selected
           if (params[:metric1].blank?)
             puts("no param 1 - default param")
             params[:metric1] = softVis3D.getMetric1FromSettings().to_s
           end
           if (params[:metric2].blank?)
             puts("no param 2 - default param")
             params[:metric2] = softVis3D.getMetric2FromSettings().to_s
           end
        %>
        <% form_tag({:action => @resource.id.to_s}, {:id => 'softVis3DForm', :method => 'get'}) do %>
            <input type="hidden" name="page" value="SoftVis3D">

            Building footprint metric:
            <select name="metric1">
                <%
                   # show all graph (as layers)
                   metrics.each do |metric|
                     if (metric.id.to_s==params[:metric1].to_s)
                %>
                        <option value="<%= metric.id %>" selected><%= metric.short_name %></option>
                    <% else %>
                        <option value="<%= metric.id %>"><%= metric.short_name %></option>
                    <% end %>
                <%
                   end
                %>
            </select>

            Building height metric:

            <select name="metric2">
                <%
                   # show all graph (as layers)
                   metrics.each do |metric|
                     if (metric.id.to_s==params[:metric2].to_s)
                %>
                        <option value="<%= metric.id %>" selected><%= metric.short_name %></option>
                    <% else %>
                        <option value="<%= metric.id %>"><%= metric.short_name %></option>
                    <% end %>
                <%
                   end
                %>
            </select>

            View type:
            <select name="viewType">
                <%
                   if ("city"==params[:viewType].to_s)
                %>
                    <option value="city" selected>City</option>
                <% else %>
                    <option value="city">City</option>
                <% end %>
                <%
                   if ("dependency"==params[:viewType].to_s)
                %>
                    <option value="dependency" selected>Dependency</option>
                <% else %>
                    <option value="dependency">Dependency</option>
                <% end %>
            </select>

            <input type="submit" value="Submit">
        <% end %>
    </div>

    <div ng-controller="DetailsController" id="detailsContainer" ng-show="node || edge"
         style="border: 1px solid black; position: absolute;
                 top: 40px; right: 10px; width: 200px; height: 300px;
                 overflow: auto;">

        <!-- NODE MAIN INFO -->

        <div ng-show="node">
            <button type='button' ng-click='showAllSceneElements();'>Show all objects (reset)</button>
            <br /><br />

            <h2 style="color: #FFBF00">{{node.name}}
                <span ng-show="!node.isNode">({{node.footprintMetricValue}} / {{node.heightMetricValue}})</span>
                <button ng-show="node.isNode" type='button' ng-click='hideAllSceneElementsExceptIdTree(node.id);'>Focus this</button>
            </h2>
        </div>

        <!-- EDGE MAIN INFO -->

        <div ng-if="edge">
            <h2 style="color: #FFBF00">
                {{edge.sourceName | inDisplay}} -> {{edge.destinationName | outDisplay}} ({{edge.includingDependencies.length}})
            </h2>
            <br />
            <button type='button' ng-click='selectAllDependentDependencies(edge);'>
                Select all depending
            </button>
            <br /><br />
        </div>

        <!-- NODE INCLUDING EDGE DETAILS -->

        <div ng-if="(inEdges.length + outEdges.length) > 0">
            <br />
            <h2>
                <img ng-hide="displayEdges" ng-click="triggerDisplayEdges();" style="vertical-align: top;"
                     src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_plus.gif"/>
                <img ng-show="displayEdges" ng-click="triggerDisplayEdges();" style="vertical-align: top;"
                     src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_minus.gif"/>
                Dependencies ({{inEdges.length + outEdges.length}})
            </h2>
            <ul ng-show="displayEdges" style="list-style: none;">
                <h3>Inbound</h3>
                <li ng-repeat="edge in inEdges">
                    <img ng-hide="edge.displayDetails" ng-click="triggerDisplayEdgeDetails(edge);" style="vertical-align: top;"
                         src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_plus.gif"/>
                    <img ng-show="edge.displayDetails" ng-click="triggerDisplayEdgeDetails(edge);" style="vertical-align: top;"
                         src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_minus.gif"/>
                    <a href='#' ng-click="selectSceneObjectFromDetails(edge.id, 'dependency');">
                        {{edge.sourceName | inDisplay}} -> ({{edge.includingDependencies.length}})
                    </a>
                    <ul ng-show="edge.displayDetails" style="list-style: circle;">
                        <li ng-repeat="dependency in edge.includingDependencies" ng-class="{listEven: $even}">
                            <a href='#' ng-click="selectAllDependentDependenciesById(dependency.id);">
                                {{dependency.displayValue}}
                            </a>
                        </li>
                    </ul>
                </li>
                <h3>Outbound</h3>
                <li ng-repeat="edge in outEdges">
                    <img ng-hide="edge.displayDetails" ng-click="triggerDisplayEdgeDetails(edge);" style="vertical-align: top;"
                         src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_plus.gif"/>
                    <img ng-show="edge.displayDetails" ng-click="triggerDisplayEdgeDetails(edge);" style="vertical-align: top;"
                         src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_minus.gif"/>
                    <a href='#' ng-click="selectSceneObjectFromDetails(edge.id, 'dependency');">
                        -> {{edge.destinationName | outDisplay}} ({{edge.includingDependencies.length}})
                    </a>
                    <ul ng-show="edge.displayDetails" style="list-style: circle;">
                        <li ng-repeat="dependency in edge.includingDependencies" ng-class="{listEven: $even}">
                            <a href='#' ng-click="selectAllDependentDependenciesById(dependency.id);">
                                {{dependency.displayValue}}
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>

        <!-- EDGE INCLUDING EDGE DETAILS -->
        <div ng-show="edgeIncludingEdges">
            <h2>
                <img ng-hide="displayEdgeIncludingEdges" ng-click="triggerDisplayEdgeIncludingEdges();" style="vertical-align: top;"
                     src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_plus.gif"/>
                <img ng-show="displayEdgeIncludingEdges" ng-click="triggerDisplayEdgeIncludingEdges();" style="vertical-align: top;"
                     src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_minus.gif"/>
                Including dependencies
            </h2>
            <ul ng-show="displayEdgeIncludingEdges" style="list-style: circle;">
                <li ng-repeat="dependency in edgeIncludingEdges" ng-class="{listEven: $even}">
                    <a href='#' ng-click="selectAllDependentDependenciesById(dependency.id);">
                        {{dependency.displayValue}}
                    </a>
                </li>
            </ul>
        </div>

        <br />
        <h2>Navigation</h2>

        <!-- NODE NAVIGATION -->
        <div ng-show="node.parentInfo">
            <br />
            <h3>Parent</h3>
            <p>
                <a href='#' ng-click="selectSceneObjectFromDetails(node.parentInfo.id, node.parentInfo.type);">
                    {{node.parentInfo.name}}
                </a>
            </p>
        </div>

        <div ng-if="node.children.length > 0">
            <br />

            <h3>
                <img ng-hide="displayChildren" ng-click="triggerDisplayChildren();" style="vertical-align: top;"
                     src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_plus.gif"/>
                <img ng-show="displayChildren" ng-click="triggerDisplayChildren();" style="vertical-align: top;"
                     src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/tree_minus.gif"/>
                Children ({{node.children.length}})
            </h3>
            <ul ng-show="displayChildren" style="list-style: none;">
                <li ng-repeat="child in node.children">
                    <img ng-hide="child.isNode" style="vertical-align: top;"
                         src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/file.gif"/>
                    <img ng-show="child.isNode" style="vertical-align: top;"
                         src="<%= "#{ApplicationController.root_context}" -%>/static/softVis3D/images/folder.gif"/>
                    <a href='#' ng-click="selectSceneObjectFromDetails(child.id, child.type);">
                        {{ child.name | limitTo:21 }}{{child.name.length > 21 ? '...' : ''}}
                        <span ng-show="!child.isNode">({{child.footprintMetricValue}}/{{child.heightMetricValue}})</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- EDGE NAVIGATION -->
        <div ng-if="edge">
            <h3>Source</h3>
            <a href='#' ng-click="selectSceneObjectFromDetails(edge.sourceId, 'node');">
                {{ edge.sourceName }}
            </a>
            <h3>Destination</h3>
            <a href='#' ng-click="selectSceneObjectFromDetails(edge.destinationId, 'node');">
                {{ edge.destinationName }}
            </a>
        </div>
    </div>

    <div ng-controller="RenderController" id="renderContainerController">
        <div ng-show="isVisualisationActive" id="renderContainer"
             ng-mousedown="mousedown($event)" ng-mouseup="mouseup($event)" ng-mousemove="mousemove($event)"
             style="border: 1px solid black;">
        </div>
        <div ng-show="!isVisualisationActive && !isLoading" style="padding: 30px; height: 300px;">
            <h3>Please select the metrics and a view type and submit the form above.</h3>
        </div>
        <div ng-show="!isVisualisationActive && isLoading" style="padding: 30px; height: 300px;">
            <h3>LOADING - please wait..</h3>
        </div>
    </div>
</div>

<script type="text/javascript">
    softVis3dAngular.controller('DetailsController',
            ['$rootScope', '$scope', 'treeService', 'sceneObjectsService',
                function ($rootScope, $scope, treeService, sceneObjectsService) {

                    $scope.node = null;
                    $scope.displayChildren = false;

                    $scope.inEdges = [];
                    $scope.outEdges = [];
                    $scope.displayEdges = false;

                    $scope.edge = null;
                    $scope.edgeIncludingEdges = null;
                    $scope.displayEdgeIncludingEdges = false;

                    $scope.showDetails = function (softVis3dId, type) {
                        if (type == "dependency") {
                            $scope.node = null;
                            $scope.edge = treeService.searchEdge(softVis3dId)
                            $scope.privateShowEdgeEdgeDetails($scope.edge);
                            $scope.inEdges = [];
                            $scope.outEdges = [];

                            console.log("including dependencies of " + $scope.edge.id + " :");
                            console.log($scope.edge.includingDependencies);
                            console.log("----------------------");
                        } else {
                            $scope.node = treeService.searchTreeNode(softVis3dId);
                            $scope.privateShowNodeEdgeDetails($scope.node);
                            $scope.edge = null;
                            $scope.edgeIncludingEdges = null;
                            $scope.displayEdgeIncludingEdges = false;
                        }
                    };

                    $scope.privateShowNodeEdgeDetails = function (sourceNode) {
                        $scope.outEdges = [];
                        // outbound dependencies
                        for (var index = 0; index < sourceNode.edges.length; index++) {
                            var sourceEdge = sourceNode.edges[index];
                            var targetEdge = {};
                            targetEdge.id = sourceEdge.id;
                            targetEdge.sourceName = sourceEdge.sourceName;
                            targetEdge.destinationName = sourceEdge.destinationName;
                            // copy including dependencies
                            targetEdge.includingDependencies = sourceEdge.includingDependencies.slice();

                            for(var j = 0; j < targetEdge.includingDependencies.length; j++) {
                                targetEdge.includingDependencies[j].displayValue =
                                        treeService.getDependencyForId(targetEdge.includingDependencies[j].id);
                            }

                            $scope.outEdges.push(targetEdge);
                        }

                        $scope.inEdges = [];
                        // inbound dependencies
                        var inboundEdges = treeService.getInboundEdges(sourceNode);
                        for (var index = 0; index < inboundEdges.length; index++) {
                            var sourceEdge = inboundEdges[index];
                            var targetEdge = {};
                            targetEdge.id = sourceEdge.id;
                            targetEdge.sourceName = sourceEdge.sourceName;
                            targetEdge.destinationName = sourceEdge.destinationName;
                            // copy including dependencies
                            targetEdge.includingDependencies = sourceEdge.includingDependencies.slice();

                            for(var j = 0; j < targetEdge.includingDependencies.length; j++) {
                                targetEdge.includingDependencies[j].displayValue =
                                        treeService.getDependencyForId(targetEdge.includingDependencies[j].id);
                            }

                            $scope.inEdges.push(targetEdge);
                        }
                    };

                    $scope.privateShowEdgeEdgeDetails = function (sourceEdge) {
                        $scope.edgeIncludingEdges = [];

                        for(var j = 0; j < sourceEdge.includingDependencies.length; j++) {
                            var result = {};
                            result.id = sourceEdge.includingDependencies[j].id;
                            result.displayValue = treeService.getDependencyForId(sourceEdge.includingDependencies[j].id);

                            $scope.edgeIncludingEdges.push(result);
                        }
                    };

                    $scope.selectAllDependentDependencies = function (edge) {
                        var clearedIncludingDependencyIds = [];
                        for (var index = 0; index < edge.includingDependencies.length; index++) {
                            clearedIncludingDependencyIds.push(edge.includingDependencies[index].id);
                        }

                        $scope.selectAllDependentDependenciesByIds(clearedIncludingDependencyIds);
                    };

                    $scope.selectAllDependentDependenciesById = function (dependencyId) {
                        var ids = [];
                        ids.push(dependencyId);
                        $scope.selectAllDependentDependenciesByIds(ids);
                    };

                    $scope.selectAllDependentDependenciesByIds = function (includingDependencyIds) {
                        var edgeIds = treeService.getAllDependentEdgeIds(includingDependencyIds);
                        sceneObjectsService.selectSceneEdgeObjects(edgeIds);
                    };

                    $rootScope.$on('objectSelected', function(event, id, type) {
                        if (type === "dependency") {
                            var edgeIds = [];
                            edgeIds.push(id);
                            sceneObjectsService.selectSceneEdgeObjects(edgeIds);
                        } else {
                            sceneObjectsService.selectSceneTreeObject(id);
                        }

                        $scope.showDetails(id, type);
                    });

                    $scope.selectSceneObjectFromDetails = function (objectId, type) {
                        if (type === "dependency") {
                            var edgeIds = [];
                            edgeIds.push(objectId);
                            sceneObjectsService.selectSceneEdgeObjects(edgeIds);
                        } else {
                            sceneObjectsService.selectSceneTreeObject(objectId);
                        }

                        $scope.showDetails(objectId, type);
                    };

                    $scope.showAllSceneElements = function () {
                        sceneObjectsService.showAllSceneElements();
                    };

                    $scope.hideAllSceneElementsExceptIdTree = function (id) {
                        var showIds = treeService.getAllSceneElementsRecursive(id);
                        sceneObjectsService.hideAllSceneElementsExceptIds(showIds);
                        sceneObjectsService.removeObject(id, "leaf");
                    };

                    $scope.triggerDisplayChildren = function () {
                        if ($scope.displayChildren) {
                            $scope.displayChildren = false;
                        } else {
                            $scope.displayChildren = true;
                        }
                    };

                    $scope.triggerDisplayEdges = function () {
                        if ($scope.displayEdges) {
                            $scope.displayEdges = false;
                        } else {
                            $scope.displayEdges = true;
                        }
                    };

                    $scope.triggerDisplayEdgeDetails = function (edge) {
                        if (edge.displayDetails) {
                            edge.displayDetails = false;
                        } else {
                            edge.displayDetails = true;
                        }
                    };

                    $scope.triggerDisplayEdgeIncludingEdges = function () {
                        if ($scope.displayEdgeIncludingEdges) {
                            $scope.displayEdgeIncludingEdges = false;
                        } else {
                            $scope.displayEdgeIncludingEdges = true;
                        }
                    };

                }
            ]
    );

window.onload = function () {
    <%
    if !@snapshot.id.blank? && !params[:viewType].blank? &&
        !params[:metric1].blank? && !params[:metric2].blank?
    %>
        // Direct link to visualization. Load and display.
        angular.element(document.getElementById('renderContainerController')).scope().loadVisualization(
                <%= @snapshot.id %>, <%= params[:metric1] %>, <%= params[:metric2] %>, "<%= params[:viewType] %>"
        );
    <%
    else
    %>
        // no direct link to visualization. Do nothing,
    <%
    end
    %>
}
</script>

